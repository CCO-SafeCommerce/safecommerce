<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="title_page">SafeCommerce | Processos </title>

    <!-- Icon -->
    <link rel="icon" href="./assets/images/logo-icon.png">

    <!-- CSS only -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-iYQeCzEYFbKjA/T2uDLTpkwGzCiq6soy8tYaI1GyVh/UjpbCx/TYkiZhlZB6+fzT" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">
    <!-- JavaScript Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-u1OknCvxWvY5kfmNBILK2hRnQC3Pr17a+RTT6rIHI7NnikvbZlHgTPOOmMi466C8" crossorigin="anonymous">
    </script>

    <!-- bootstrap -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.9.1/font/bootstrap-icons.css">

    <!-- JavaScript WordCloud -->
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-base.min.js"></script>
    <script src="https://cdn.anychart.com/releases/v8/js/anychart-tag-cloud.min.js"></script>

    <!-- style -->
    <link rel="stylesheet" href="./css/main.css">
    <link rel="stylesheet" href="./css/servidores.css">
    <link rel="stylesheet"  type="text/css" href="./css/processos.css">
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>

<body onresize="responsive()" onload="responsive(), validateSession()">

    <div id="wrapper">
        <div id="overlay">
        </div>
        <!-- barra lateral -->
        <my-sidebar></my-sidebar>
        <!-- Fim barra lateral  -->

        <!-- Barra de navegação -->
        <div id="page-content-wrapper">
            <div id="content">
                <div class="container-fluid p-0 px-lg-0 px-md-0">
                    <my-navbar></my-navbar>
                    <!-- Fim da barra de navegação -->

                    <!-- Conteudo da página -->
                    <div class="container-fluid px-lg-4">
                        <div class="row">
                            <div class="col-md-12 mt-lg-4 mt-4">
                                <nav aria-label="breadcrumb">
                                    <ol class="breadcrumb bg-transparent">
                                        <li class="breadcrumb-item"><a href="./painel.html" class="link-primary">Visão Geral</a></li>
                                        <li class="breadcrumb-item"><a id="breadcrumbServidor" class="link-primary">Servidor</a></li>
                                        <li class="breadcrumb-item" aria-current="page">Editar Servidor</li>
                                    </ol>
                                </nav> 
                                <div class="d-flex align-items-center justify-content-between mb-4">
                                    <h1 class="h3 mb-0 text-gray-800">Processos</h1>
                                </div>
                            </div>

                            <!-- Cards -->
                            <div class="col-md-12">
                                <div class="col-md-12 mt-4 margin-table">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-hover v-middle">
                                            <thead class="bg-white">
                                                <tr>
                                                    <th class="border-top-0 col-2" >Nome: <span id="nome1"></span></th>
                                                    <th class="border-top-0 col-2" >PID: <span id="pid1"></span></th>
                                                    <th class="border-top-0 col-2" >Uso de CPU: <span id="cpu1"></span></th>
                                                    <th class="border-top-0 col-2" >Uso de ram: <span id="ram1"></span></th>
                                                    <th class="border-top-0 col-2" >
                                                        <button onclick="encerrarProcessos(0)" class="btn btn-primary">Encerrar processo</button>
                                                    </th>
                                                </tr>
                                            </thead>
                                        </table>
                                        <table class="table table-striped table-hover v-middle">
                                            <thead class="bg-white">
                                                <tr>
                                                    <th class="border-top-0 col-2" >Nome: <span id="nome2"></span></th>
                                                    <th class="border-top-0 col-2" >PID: <span id="pid2"></span></th>
                                                    <th class="border-top-0 col-2" >Uso de CPU: <span id="cpu2"></span></th>
                                                    <th class="border-top-0 col-2" >Uso de ram: <span id="ram2"></span></th>
                                                    <th class="border-top-0 col-2" >
                                                        <button onclick="encerrarProcessos(1)" class="btn btn-primary">Encerrar processo</button>
                                                    </th>
                                                </tr>
                                            </thead>
                                        </table>
                                        <table class="table table-striped table-hover v-middle">
                                            <thead class="bg-white">
                                                <tr>
                                                    <th class="border-top-0 col-2 " >Nome: <span id="nome3"></span></th>
                                                    <th class="border-top-0 col-2" >PID: <span id="pid3"></span></th>
                                                    <th class="border-top-0 col-2" >Uso de CPU: <span id="cpu3"></span></th>
                                                    <th class="border-top-0 col-2" >Uso de ram: <span id="ram3"></span></th>
                                                    <th class="border-top-0 col-2" >
                                                        <button onclick="encerrarProcessos(2)" class="btn btn-primary">Encerrar processo</button>
                                                    </th>
                                                </tr>
                                            </thead>
                                        </table>
                                        <table class="table table-striped table-hover v-middle">
                                            <thead class="bg-white">
                                                <tr>
                                                    <th class="border-top-0 col-2" >Nome: <span id="nome4"></span></th>
                                                    <th class="border-top-0 col-2" >PID: <span id="pid4"></span></th>
                                                    <th class="border-top-0 col-2" >Uso de CPU: <span id="cpu4"></span></th>
                                                    <th class="border-top-0 col-2" >Uso de ram: <span id="ram4"></span></th>
                                                    <th class="border-top-0 col-2" >
                                                        <button onclick="encerrarProcessos(3)" class="btn btn-primary">Encerrar processo</button>
                                                    </th>
                                                </tr>
                                            </thead>
                                        </table>
                                        <table class="table table-striped table-hover v-middle">
                                            <thead class="bg-white">
                                                <tr>
                                                    <th class="border-top-0 col-2" >Nome: <span id="nome5"></span></th>
                                                    <th class="border-top-0 col-2" >PID: <span id="pid5"></span></th>
                                                    <th class="border-top-0 col-2" >Uso de CPU: <span id="cpu5"></span></th>
                                                    <th class="border-top-0 col-2" >Uso de ram: <span id="ram5"></span></th>
                                                    <th class="border-top-0 col-2" >
                                                        <button onclick="encerrarProcessos(4)" class="btn btn-primary">Encerrar processo</button>
                                                    </th>
                                                </tr>
                                            </thead>
                                        </table>
                                        <table class="table table-striped table-hover v-middle">
                                            <thead class="bg-white">
                                                <tr>
                                                    <th class="border-top-0 col-2" >Nome: <span id="nome6"></span></th>
                                                    <th class="border-top-0 col-2" >PID: <span id="pid6"></span></th>
                                                    <th class="border-top-0 col-2" >Uso de CPU: <span id="cpu6"></span></th>
                                                    <th class="border-top-0 col-2" >Uso de ram: <span id="ram6"></span></th>
                                                    <th class="border-top-0 col-2" >
                                                        <button onclick="encerrarProcessos(5)" class="btn btn-primary">Encerrar processo</button>
                                                    </th>
                                                </tr>
                                            </thead>
                                        </table>
                                        <table class="table table-striped table-hover v-middle">
                                            <thead class="bg-white">
                                                <tr>
                                                    <th class="border-top-0 col-2" >Nome: <span id="nome7"></span></th>
                                                    <th class="border-top-0 col-2" >PID: <span id="pid7"></span></th>
                                                    <th class="border-top-0 col-2" >Uso de CPU: <span id="cpu7"></span></th>
                                                    <th class="border-top-0 col-2" >Uso de ram: <span id="ram7"></span></th>
                                                    <th class="border-top-0 col-2" >
                                                        <button onclick="encerrarProcessos(6)" class="btn btn-primary">Encerrar processo</button>
                                                    </th>
                                                </tr>
                                            </thead>
                                        </table>
                                        <table class="table table-striped table-hover v-middle">
                                            <thead class="bg-white">
                                                <tr>
                                                    <th class="border-top-0 col-2" >Nome: <span id="nome8"></span></th>
                                                    <th class="border-top-0 col-2" >PID: <span id="pid8"></span></th>
                                                    <th class="border-top-0 col-2" >Uso de CPU: <span id="cpu8"></span></th>
                                                    <th class="border-top-0 col-2" >Uso de ram: <span id="ram8"></span></th>
                                                    <th class="border-top-0 col-2" >
                                                        <button onclick="encerrarProcessos(7)" class="btn btn-primary">Encerrar processo</button>
                                                    </th>
                                                </tr>
                                            </thead>
                                        </table>
                                        <table class="table table-striped table-hover v-middle">
                                            <thead class="bg-white">
                                                <tr>
                                                    <th class="border-top-0 col-2" >Nome: <span id="nome9"></span></th>
                                                    <th class="border-top-0 col-2" >PID: <span id="pid9"></span></th>
                                                    <th class="border-top-0 col-2" >Uso de CPU: <span id="cpu9"></span></th>
                                                    <th class="border-top-0 col-2" >Uso de ram: <span id="ram9"></span></th>
                                                    <th class="border-top-0 col-2" >
                                                        <button onclick="encerrarProcessos(8)" class="btn btn-primary">Encerrar processo</button>
                                                    </th>
                                                </tr>
                                            </thead>
                                        </table>
                                        <table class="table table-striped table-hover v-middle">
                                            <thead class="bg-white">
                                                <tr>
                                                    <th class="border-top-0 col-2" >Nome: <span id="nome10"></span></th>
                                                    <th class="border-top-0 col-2" >PID: <span id="pid10"></span></th>
                                                    <th class="border-top-0 col-2" >Uso de CPU: <span id="cpu10"></span></th>
                                                    <th class="border-top-0 col-2" >Uso de ram: <span id="ram10"></span></th>
                                                    <th class="border-top-0 col-2" >
                                                        <button onclick="encerrarProcessos(9)" class="btn btn-primary">Encerrar processo</button>
                                                    </th>
                                                </tr>
                                            </thead>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="listagemProcessos">
                    
                </div>
                <!-- Fim do conteudo da página -->

                <!-- Footer -->
                <my-footer></my-footer>
            </div>
        </div>
    </div>
</body>

<script src="./js/main.js"></script>
<script src="./js/script.js"></script>

<script>
const indexPage = false;
var selectedServer = 0;
    function getURLParams() {
        var params = new URLSearchParams(window.location.search)
        var idServidor = params.get('idServer')

        if (idServidor != null) {
            selectedServer = idServidor
            var servers = JSON.parse(sessionStorage.SERVERS)

            var servidor = servers.find(s => {
                if (s.idServidor == idServidor) {
                    return s
                }
            })

            if (!servidor){
                window.location = './painel.html'
            }

            var breadcrumb = document.getElementById('breadcrumbServidor');
            breadcrumb.innerText = servidor.modelo
            breadcrumb.href = `./servidores.html?idServer=${servidor.idServidor}`

            obterProcessos(selectedServer)
        } else {
            window.location = './painel.html'
        }
    }
    
    
    function obterProcessos(selectedServer) {
        console.log("CHAMEI A FUNÇÂO")
    fetch(`/processos/obterProcessos/${selectedServer}`, {
        method: "GET",
        headers: {
            "Content-Type": "application/json"
        }
    }).then(function (response) {
        if (response.ok) {
            response.json().then(function (resposta) {
                inserirProcessos(resposta);
            });
        } else {
            console.error('Nenhum dado encontrado ou erro na API');
        }
    })
    .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });
}


processos=[]

function inserirProcessos(resposta){


    for(var i = 0;i < resposta.length; i++){
        var nome = document.getElementById(`nome${i+1}`)
        var pid = document.getElementById(`pid${i+1}`)
        var cpu = document.getElementById(`cpu${i+1}`)
        var ram = document.getElementById(`ram${i+1}`)

        if(nome && pid && cpu && ram){
            nome.innerHTML = resposta[i].nome;
            pid.innerHTML = resposta[i].pid;
            cpu.innerHTML = resposta[i].usoCpu+ "%";
            ram.innerHTML = resposta[i].usoRam+ "%";
            
        }
    }
        
        processos = resposta;
}
function encerrarProcessos(valor){
        pidEncerramento = processos[valor].pid;
    
    fetch(`/processos/encerrarProcessos/${selectedServer}`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({
                pid: pidEncerramento,
                idServidor: selectedServer
            })
    }).then(function (response) {
        if (response.ok) {
            response.json().then(function (resposta) {
                inserirProcessos(resposta);
            });
        } else {
            console.error('Nenhum dado encontrado ou erro na API');
        }
    })
    .catch(function (error) {
        console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
    });
    
}

getData(indexPage)
getURLParams()
setInterval(() => {
    obterProcessos(selectedServer),
    getData(indexPage),
    anychart.onDocumentReady(wordCloud())
    }, 15000)

</script>